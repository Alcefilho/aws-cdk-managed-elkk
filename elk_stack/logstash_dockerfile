FROM      centos:8

# update packages
RUN yum update -y

# install java
RUN yum install java-11-openjdk-devel -y

# install git
RUN yum install git -y

# logstash
RUN rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch

# move logstash repo file
ADD logstash.repo /etc/yum.repos.d/logstash.repo

# install logstash with yum
RUN yum install logstash -y

# place the config
ADD logstash.yml /etc/logstash/logstash.yml

# place the pipeline
ADD logstash.conf.asset /etc/logstash/conf.d/logstash.conf

# make directory for plugins
RUN mkdir /usr/share/logstash/plugins
# get elastic output to es
RUN git clone https://github.com/awslabs/logstash-output-amazon_es.git /usr/share/logstash/plugins/logstash-output-amazon_es

# update gemfile
RUN sed -i '5igem "logstash-output-amazon_es", :path => "/usr/share/logstash/plugins/logstash-output-amazon_es"' /usr/share/logstash/Gemfile

# get logstash starter script
ADD logstash_start.sh /usr/local/bin/logstash_start.sh
RUN chmod +x /usr/local/bin/logstash_start.sh

# make logs directory
RUN mkdir /opt/logs

# start logstash
CMD /usr/local/bin/start_logstash.sh